# Parquet 文件格式

## 概述

**Apache Parquet** 是一种为大数据处理系统设计的、开源的**列式存储格式**。它以其极高的压缩比和卓越的查询性能而闻名，已成为大数据生态系统中事实上的标准存储格式之一。

## 核心概念：列式存储 vs 行式存储

### 行式存储
- **存储方式**：数据按行存储，整行数据连续存放
- **典型代表**：CSV、JSONL、传统关系型数据库
- **数据布局示例**：
  ```
  [Row1: ID, Name, Age, Salary], [Row2: ID, Name, Age, Salary], ...
  ```
- **优点**：写入高效，适合事务型操作
- **缺点**：查询时需读取整行，即使只需要少数几列

### 列式存储
- **存储方式**：数据按列存储，同列数据连续存放
- **典型代表**：Parquet、ORC
- **数据布局示例**：
  ```
  [All Rows: ID], [All Rows: Name], [All Rows: Age], [All Rows: Salary]
  ```
- **优点**：查询时只读取所需列，压缩效率高

## Parquet 的核心优势

### 1. 极高的压缩率
- 同列数据类型一致，便于优化编码
- 支持多种压缩算法（Snappy、GZIP、LZO等）
- 通常可将数据压缩至原始大小的1/10甚至更小

### 2. 卓越的查询性能
- **列裁剪**：只读取查询涉及的列，减少I/O
- **谓词下推**：利用列统计信息跳过不相关的数据块
- **向量化执行**：适合现代CPU的批量处理模式

### 3. 模式演化
- 内置Schema信息，支持向前/向后兼容
- 可以安全地添加新列，不会破坏现有数据

### 4. 广泛的生态系统支持
- **处理框架**：Spark、Hive、Impala、Presto
- **编程语言**：Python（Pandas + PyArrow）、Java、C++
- **数据库系统**：DuckDB、ClickHouse等

## 文件结构

### 物理组成
```
Parquet File
├── Header (Magic Number)
├── Row Group 1
│   ├── Column Chuck for Column A
│   │   ├── Page 1 (Data/Dictionary)
│   │   ├── Page 2
│   │   └── ...
│   ├── Column Chuck for Column B
│   └── ...
├── Row Group 2
├── ...
└── Footer
    ├── File Metadata
    ├── Schema Information
    ├── Column Statistics (min/max)
    └── Row Group Locations
```

### 关键组件说明
- **行组**：数据的水平分区
- **列块**：行组内按列存储的数据单元
- **页**：编码、压缩和访问的最小单位
- **页头**：包含页的元数据和统计信息
- **文件尾**：存储文件的全局元数据和索引信息

## 技术特性

### 编码方案
- **PLAIN**：简单编码，适用于所有类型
- **RLE**：游程编码，适用于重复值多的数据
- **字典编码**：为重复值创建字典，极大提升压缩率
- **Delta编码**：适用于有序的数值数据

### 压缩支持
- **无压缩**：UNCOMPRESSED
- **快速压缩**：SNAPPY、LZO
- **高压缩比**：GZIP、BROTLI、ZSTD

### 嵌套数据支持
- 基于Google Dremel的重复级别/定义级别算法
- 原生支持复杂类型：Struct、List、Map
- 完美处理JSON-like的半结构化数据

## 适用场景

✅ 推荐使用场景
- **数据仓库和分析工作负载**（OLAP）
- **大数据批处理作业**
- **数据湖存储格式**
- **长期数据归档**
- **机器学习特征存储**

❌ 不推荐场景
- **事务处理系统**（OLTP）
- **频繁的单行读写操作**
- **小型临时数据集**
- **需要逐行处理所有数据的场景**

## 性能对比

| 特性     | CSV | JSON | Parquet  |
| -------- | --- | ---- | -------- |
| 存储效率 | 低  | 中   | **极高** |
| 查询性能 | 慢  | 中   | **极快** |
| 压缩率   | 低  | 中   | **极高** |
| 模式支持 | 无  | 弱   | **强**   |
| 写入速度 | 快  | 快   | **中等** |